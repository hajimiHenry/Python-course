# 文件读写和异常处理（可读性优化版）

> 原文：`Python-100-Days/Day21-30/21.文件读写和异常处理.md`

---

## 一、为什么需要文件操作？

程序运行时数据存在**内存**里，一关闭就消失了。  
想让数据"留下来"，就要写入**硬盘**——这就是**数据持久化**。  
最简单的方式：把数据存到**文件**里。

---

## 二、打开和关闭文件

### 基本用法

```python
file = open('文件名', '操作模式', encoding='utf-8')
# ... 对文件做操作 ...
file.close()   # 用完一定要关！
```

### 操作模式速查表

| 模式 | 含义 |
|------|------|
| `'r'` | 读取（默认） |
| `'w'` | 写入（会清空原内容） |
| `'a'` | 追加（在末尾继续写） |
| `'x'` | 写入，文件已存在则报错 |
| `'b'` | 二进制模式（配合 r/w 使用，如 `'rb'`） |
| `'t'` | 文本模式（默认） |
| `'+'` | 可读可写 |

> **记住**：`'r'`、`'w'`、`'a'` 是最常用的三个。

---

## 三、读写文本文件

### 读取文件

```python
# 方式1：一次性读取全部内容
file = open('致橡树.txt', 'r', encoding='utf-8')
print(file.read())
file.close()

# 方式2：逐行读取（适合大文件）
file = open('致橡树.txt', 'r', encoding='utf-8')
for line in file:
    print(line, end='')
file.close()

# 方式3：读取所有行到列表
file = open('致橡树.txt', 'r', encoding='utf-8')
lines = file.readlines()   # 返回一个列表，每行是一个元素
for line in lines:
    print(line, end='')
file.close()
```

### 写入文件

```python
# 'a' = 追加模式（不会删除原内容）
file = open('致橡树.txt', 'a', encoding='utf-8')
file.write('\n标题：《致橡树》')
file.write('\n作者：舒婷')
file.write('\n时间：1977年3月')
file.close()
```

---

## 四、异常处理机制

### 为什么需要异常处理？

如果文件不存在，直接 `open()` 会让程序**直接崩溃**。  
异常处理让程序能**优雅地应对错误**，而不是崩溃退出。

### 五个核心关键词

| 关键词 | 作用 | 必须有吗？ |
|--------|------|-----------|
| `try` | 放"可能出错"的代码 | ✅ 必须 |
| `except` | 某种错误发生时怎么办 | 和 `finally` 至少有一个 |
| `else` | **没出错**时才执行 | ❌ 可选 |
| `finally` | **不管有没有出错**都执行，常用于释放资源 | 和 `except` 至少有一个 |
| `raise` | 主动抛出一个异常 | ❌ 可选 |

### 基本结构

```python
try:
    # 放可能出错的代码
except 某种异常:
    # 发生这种错时的处理
except 另一种异常:
    # 发生那种错时的处理
else:
    # 没有任何异常时执行
finally:
    # 无论如何都执行（通常用来关闭文件/释放资源）
```

### 文件操作中的异常处理示例

```python
file = None  # ⚠️ 提前设为 None，防止 open() 失败时 finally 里报 NameError
try:
    file = open('致橡树.txt', 'r', encoding='utf-8')
    print(file.read())
except FileNotFoundError:       # 文件根本不存在
    print('无法打开指定的文件!')
except LookupError:              # encoding 参数写了个不认识的编码名
    print('指定了未知的编码!')
except UnicodeDecodeError:       # 文件内容和编码不匹配，读不出来
    print('读取文件时解码错误!')
finally:
    if file:
        file.close()             # 确保文件被关闭
```

> **`file = None` 为什么放在 `try` 外面？**  
> 如果 `open()` 刚执行就失败了，`file` 变量根本没被赋值。  
> 若直接在 `finally` 里写 `if file`，Python 会报 `NameError: name 'file' is not defined`。  
> 提前赋值 `None`，`finally` 里的 `if file` 就能安全地判断"文件有没有成功打开"。

---

## 五、更推荐的写法：`with` 语句

`with` 会在代码块结束后**自动调用 `close()`**，不需要再手写 `finally`，代码更简洁。

```python
try:
    with open('致橡树.txt', 'r', encoding='utf-8') as file:
        print(file.read())
except FileNotFoundError:
    print('无法打开指定的文件!')
except LookupError:
    print('指定了未知的编码!')
except UnicodeDecodeError:
    print('读取文件时解码错误!')
```

> **实际项目中几乎都用这种写法**，简洁、安全、不容易忘记关文件。

---

## 六、主动抛出异常：`raise`

当函数收到**不合法的输入**时，可以用 `raise` 主动报错，告知调用者哪里出了问题。

### 步骤一：定义自定义异常类型

```python
class InputError(ValueError):
    """自定义异常：输入值不合法"""
    pass
```

> 继承 `ValueError` 是因为"输入值的问题"属于值错误。  
> 大多数自定义异常应继承自 `Exception` 或其子类。

### 步骤二：在函数中抛出异常

```python
def fac(num):
    """求阶乘"""
    if num < 0:
        raise InputError('只能计算非负整数的阶乘')  # 主动抛出
    if num in (0, 1):
        return 1
    return num * fac(num - 1)
```

### 步骤三：调用时捕获异常

```python
flag = True
while flag:
    num = int(input('n = '))
    try:
        print(f'{num}! = {fac(num)}')
        flag = False               # 计算成功才退出循环
    except InputError as err:
        print(err)                 # 打印异常信息，继续循环让用户重新输入
```

---

## 七、读写二进制文件

处理图片、音频等非文本文件时，使用二进制模式 `'rb'` / `'wb'`。

```python
# 将图片复制一份（小文件，一次性读取）
try:
    with open('guido.jpg', 'rb') as file1:
        data = file1.read()
    with open('吉多.jpg', 'wb') as file2:
        file2.write(data)
except FileNotFoundError:
    print('指定的文件无法打开.')
except IOError:
    print('读写文件时出现错误.')
print('程序执行结束.')
```

```python
# 大文件分块复制（节省内存）
try:
    with open('guido.jpg', 'rb') as file1, open('吉多.jpg', 'wb') as file2:
        data = file1.read(512)     # 每次读 512 字节
        while data:
            file2.write(data)
            data = file1.read(512) # 继续读下一块
except FileNotFoundError:
    print('指定的文件无法打开.')
except IOError:
    print('读写文件时出现错误.')
print('程序执行结束.')
```

---

## 八、常见异常类型速查

只需记住这几个最常用的，其他遇到了再查：

| 异常类型 | 触发场景 |
|----------|---------|
| `FileNotFoundError` | 文件不存在 |
| `PermissionError` | 没有读/写权限 |
| `UnicodeDecodeError` | 文件编码与指定编码不匹配 |
| `LookupError` | 指定了不存在的编码名称 |
| `IOError` | 读写文件时发生 I/O 错误 |
| `ValueError` | 值不合法（如 `int('abc')`） |
| `ZeroDivisionError` | 除以零 |
| `IndexError` | 列表下标越界 |
| `KeyError` | 字典中不存在该键 |

---

## 九、总结

| 场景 | 推荐做法 |
|------|---------|
| 打开文件 | 用 `with open(...) as file:` |
| 捕获错误 | 用 `try...except`，指定具体异常类型 |
| 释放资源 | 优先用 `with`；不得已才用 `finally` |
| 函数输入非法 | 用 `raise` 主动抛出自定义异常 |
| 捕获所有异常 | ⚠️ 谨慎使用，可能掩盖真正的 bug |

> **最后一条原则**：不要用异常机制来控制程序的正常流程——异常只用来处理"意外情况"。
